# Архитектура TRYGO BusinessHypothesis Generator

## Обзор системы

TRYGO BusinessHypothesis Generator - это WordPress плагин, который анализирует веб-сайты и генерирует бизнес-гипотезы с использованием OpenAI API.

## Архитектурные принципы

### 1. Модульность
- Разделение на логические модули (админ, фронтенд, API)
- Каждый модуль имеет свою ответственность
- Легкость тестирования и поддержки

### 2. Безопасность
- Все AJAX запросы защищены nonce токенами
- Санитизация всех входных данных
- Проверка прав доступа
- Безопасное хранение API ключей

### 3. Производительность
- Кэширование результатов
- Асинхронная обработка запросов
- Оптимизация запросов к БД
- Минимальная нагрузка на сервер

### 4. Расширяемость
- Хуки WordPress для интеграции
- Настраиваемые промпты
- Возможность добавления новых источников данных

## Структура плагина

```
business-hypothesis-generator/
├── business-hypothesis-generator.php      # Основной класс плагина
├── business-hypothesis-generator-info.php # Информация о плагине
├── admin/
│   └── admin-page.php                     # Админ интерфейс
├── assets/
│   ├── css/
│   │   └── frontend.css                   # Стили фронтенда
│   └── js/
│       └── frontend.js                    # JavaScript логика
├── includes/
│   └── shortcode.php                      # Шорткод для вставки
└── languages/                             # Файлы локализации
```

## Компоненты системы

### 1. Основной класс (BusinessHypothesisGenerator)

**Ответственность:**
- Инициализация плагина
- Регистрация хуков WordPress
- AJAX обработчики
- Интеграция с OpenAI API

**Ключевые методы:**
- `generate_business_hypothesis()` - AJAX обработчик генерации
- `generate_hypotheses_via_openai()` - Интеграция с OpenAI
- `get_website_content()` - Получение контента сайта
- `save_hypothesis_analysis()` - Сохранение в БД

### 2. Админ класс (BusinessHypothesisAdmin)

**Ответственность:**
- Создание админ меню
- Настройки API ключа
- Управление промптами
- Тестирование API

**Ключевые методы:**
- `add_admin_menu()` - Регистрация админ страниц
- `admin_page()` - Главная страница
- `settings_page()` - Страница настроек

### 3. Фронтенд (JavaScript)

**Ответственность:**
- Валидация URL
- AJAX запросы к серверу
- Отображение результатов
- Копирование в буфер обмена

**Ключевые функции:**
- `analyzeWebsite()` - Анализ сайта
- `displayResults()` - Показ результатов
- `copyHypothesis()` - Копирование гипотез

### 4. Шорткод

**Ответственность:**
- Генерация HTML интерфейса
- Интеграция с WordPress
- Отображение на страницах

## Поток данных

### 1. Пользовательский ввод
```
Пользователь → URL сайта → Валидация → AJAX запрос
```

### 2. Обработка на сервере
```
AJAX → Проверка nonce → Получение контента сайта → OpenAI API → Сохранение в БД → Ответ
```

### 3. Отображение результатов
```
JSON ответ → Парсинг → Генерация HTML → Отображение карточек
```

## Интеграция с внешними сервисами

### OpenAI API

**Endpoint:** `https://api.openai.com/v1/chat/completions`

**Модель:** `gpt-3.5-turbo`

**Формат запроса:**
```json
{
  "model": "gpt-3.5-turbo",
  "messages": [
    {
      "role": "user",
      "content": "Промпт с контентом сайта"
    }
  ],
  "max_tokens": 2000,
  "temperature": 0.7
}
```

**Формат ответа:**
```json
{
  "hypotheses": [
    {
      "title": "Название гипотезы",
      "description": "Описание",
      "test_method": "Метод тестирования",
      "success_metrics": "Метрики успеха"
    }
  ]
}
```

## База данных

### Таблица: `wp_business_hypothesis_analyses`

```sql
CREATE TABLE wp_business_hypothesis_analyses (
    id mediumint(9) NOT NULL AUTO_INCREMENT,
    website_url varchar(500) NOT NULL,
    hypotheses_data longtext NOT NULL,
    created_at datetime DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id)
);
```

**Назначение:**
- Хранение истории анализов
- Кэширование результатов
- Аналитика использования

## Безопасность

### 1. AJAX безопасность
- Nonce токены для всех запросов
- Проверка прав доступа
- Санитизация входных данных

### 2. API ключи
- Хранение в зашифрованном виде
- Проверка валидности
- Логирование ошибок

### 3. Входные данные
- Валидация URL
- Санитизация текста
- Ограничение длины контента

## Производительность

### 1. Кэширование
- Результаты OpenAI API
- Контент веб-сайтов
- Настройки плагина

### 2. Оптимизация
- Асинхронная обработка
- Минимальные запросы к БД
- Сжатие ответов

### 3. Мониторинг
- Логирование ошибок
- Отслеживание производительности
- Статистика использования

## Обработка ошибок

### 1. Уровни ошибок
- **Критические:** Недоступность API, ошибки БД
- **Предупреждения:** Неверный URL, превышение лимитов
- **Информационные:** Демо режим, кэшированные результаты

### 2. Стратегии восстановления
- Fallback на демо данные
- Повторные попытки запросов
- Graceful degradation

### 3. Уведомления пользователя
- Информативные сообщения об ошибках
- Предложения по решению проблем
- Контактная информация поддержки

## Расширяемость

### 1. Хуки WordPress
```php
// Фильтр для модификации промпта
apply_filters('business_hypothesis_prompt', $prompt, $website_url);

// Действие после генерации гипотез
do_action('business_hypothesis_generated', $hypotheses, $website_url);

// Фильтр для кастомизации HTML
apply_filters('business_hypothesis_html', $html, $hypotheses);
```

### 2. Дополнительные источники данных
- RSS фиды
- Социальные сети
- Аналитика сайтов
- CRM системы

### 3. Новые типы гипотез
- Маркетинговые
- Продуктовые
- Операционные
- Финансовые

## Мониторинг и аналитика

### 1. Метрики использования
- Количество анализов
- Популярные сайты
- Время генерации
- Успешность запросов

### 2. Производительность
- Время ответа API
- Использование ресурсов
- Ошибки и исключения

### 3. Бизнес метрики
- Конверсия в использование
- Retention пользователей
- Feedback и рейтинги

## Развертывание

### 1. Требования к серверу
- WordPress 5.0+
- PHP 7.4+
- cURL расширение
- SSL сертификат

### 2. Настройка
- Установка API ключей
- Конфигурация промптов
- Тестирование функциональности

### 3. Мониторинг
- Логи ошибок
- Производительность
- Использование ресурсов

---

**Архитектура спроектирована для масштабируемости, безопасности и простоты поддержки.**
